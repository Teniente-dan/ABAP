""""""""""""""""""""""" STATUS is defined in a FG and loaded via Object Name   
CLASS zcl_rt_bau_revinv_alv DEFINITION
  PUBLIC
  INHERITING FROM cl_salv_model_list
  CREATE PUBLIC .

  PUBLIC SECTION.

    TYPES:
      BEGIN OF ty_fields,
        field TYPE string,  "Name of field
        key   TYPE boolean, "key for managing global alv
        idx   TYPE boolean, "indicates if the field is to be used as idx in some process;
        "idx is excluded from keys in some process
        tech  TYPE boolean, "technical field
        text  TYPE string,  "text to show in column
        sort  TYPE i,       "used in sort process and indicates order position
        edit  TYPE boolean, "field to be modify-enabled
        icon  TYPE boolean, "field used as icon
      END OF ty_fields .
    TYPES:
      tt_fields TYPE SORTED TABLE OF ty_fields WITH UNIQUE KEY field .

    EVENTS to_update
      EXPORTING
        VALUE(e_to_update) TYPE REF TO data
        VALUE(e_info) TYPE string .
    EVENTS to_save
      EXPORTING
        VALUE(mod_tab) TYPE REF TO data .
    EVENTS to_val
      EXPORTING
        VALUE(e_to_val) TYPE REF TO data .
    EVENTS to_end
      EXPORTING
        VALUE(e_to_end) TYPE REF TO data .

    METHODS display_alv
      IMPORTING
        !i_no_refresh TYPE boolean OPTIONAL .
    METHODS constructor
      IMPORTING
        !i_tab_to_alv TYPE REF TO data
        !i_key_fields TYPE tt_fields
        !i_status     TYPE string .
    METHODS set_data_saved
      IMPORTING
        !i_save_ok TYPE boolean .
    CLASS-METHODS send_message
      IMPORTING
        !i_type_message TYPE char1
        !i_conf         TYPE boolean OPTIONAL
        !i_message      TYPE string
      RETURNING
        VALUE(r_ok)     TYPE char1 .
    METHODS set_val_ok
      IMPORTING
        !i_val_ok TYPE boolean .
  PROTECTED SECTION.
  PRIVATE SECTION.

    TYPES:
      BEGIN OF ty_cnst,
        fname TYPE fname_021,
        numb  TYPE  tvarv_numb,
        sign  TYPE  tvarv_sign,
        opti  TYPE  tvarv_opti,
        low   TYPE tvarv_val,
        high  TYPE  tvarv_val,
      END OF ty_cnst .
    TYPES:
      tt_cnst TYPE SORTED TABLE OF ty_cnst WITH NON-UNIQUE KEY fname numb .
    TYPES:
      BEGIN OF ty_sel,
        sel_key   TYPE string,
        sel_key_p TYPE string,
      END OF ty_sel .

    DATA selection_key TYPE ty_sel .
    DATA status TYPE string .
    DATA gt_outab TYPE REF TO data .
    DATA gt_to_db TYPE REF TO data .
    DATA gr_table TYPE REF TO cl_salv_table .
    DATA gt_cnst TYPE tt_cnst .
    CLASS-DATA c_bo_bau TYPE string VALUE 'BO_BAU' ##NO_TEXT.
    CLASS-DATA c_ip_serv_out TYPE string VALUE 'IP_SERV_OUT' ##NO_TEXT.
    CLASS-DATA c_ip_serv_in TYPE string VALUE 'IP_SERV_IN' ##NO_TEXT.
    CLASS-DATA parser TYPE char1 VALUE ',' ##NO_TEXT.
    DATA save_ok TYPE boolean .
    DATA gt_keys TYPE tt_fields .
    DATA mod_idx TYPE i .
    DATA val_ok TYPE boolean .

    METHODS save_data
      CHANGING
        !o_tab      TYPE REF TO data OPTIONAL
      RETURNING
        VALUE(i_ok) TYPE boolean .
    METHODS atta_borrar
      RETURNING
        VALUE(r_ok) TYPE boolean .
    METHODS add_to_mod_db
      IMPORTING
        !i_line TYPE REF TO data .
    METHODS get_regs_from_dist
      RETURNING
        VALUE(r_tab) TYPE REF TO data .
    METHODS save_sequence
      RETURNING
        VALUE(r_ok) TYPE boolean .
    METHODS get_tabkey_from_sel
      IMPORTING
        !i_to_parse     TYPE boolean OPTIONAL
      RETURNING
        VALUE(r_tabkey) TYPE string .
    METHODS check_changes .
    METHODS load_cnst
      RETURNING
        VALUE(i_ok) TYPE boolean .
    METHODS atta_carga
      RETURNING
        VALUE(r_ok) TYPE boolean .
    METHODS atta_mostrar .
    METHODS set_sort
      IMPORTING
        !i_no_refresh TYPE boolean OPTIONAL .
    METHODS update_line
      IMPORTING
        !i_tab   TYPE REF TO data
        !i_filed TYPE boolean .
    METHODS set_editable
      IMPORTING
        !i_fields TYPE tt_fields .
    METHODS set_columns
      CHANGING
        !io_table TYPE REF TO cl_salv_table .
    METHODS set_functions
      CHANGING
        !io_table TYPE REF TO cl_salv_table .
    METHODS create_alv
      CHANGING
        !i_tab TYPE ANY TABLE .
    METHODS user_commando
          FOR EVENT added_function OF cl_salv_events
      IMPORTING
          !e_salv_function .
    METHODS set_events
      CHANGING
        !io_table TYPE REF TO cl_salv_table .
    METHODS handle_data_changed
          FOR EVENT data_changed OF cl_gui_alv_grid
      IMPORTING
          !er_data_changed .
    METHODS end_process
      RETURNING
        VALUE(r_ok) TYPE boolean .
ENDCLASS.



CLASS ZCL_RT_BAU_REVINV_ALV IMPLEMENTATION.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->ADD_TO_MOD_DB
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_LINE                         TYPE REF TO DATA
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD add_to_mod_db.
    FIELD-SYMBOLS: <fs_inline> TYPE any,
                   <fs_outab>  TYPE ANY TABLE, "global tab with master data
                   <fs_modtab> TYPE STANDARD TABLE. "data to be updated in db
    DATA: otab  TYPE abap_sortorder_tab.

    ASSIGN gt_outab->* TO <fs_outab>.
    ASSIGN i_line->* TO <fs_inline>.

    IF gt_to_db IS NOT BOUND.
      CREATE DATA gt_to_db LIKE <fs_outab>.
    ENDIF.
    ASSIGN gt_to_db->* TO <fs_modtab>.

    DATA(idx) = VALUE #( gt_keys[ idx = abap_true ]-field OPTIONAL ).
    IF idx IS NOT INITIAL.
      ASSIGN COMPONENT idx OF STRUCTURE <fs_inline> TO FIELD-SYMBOL(<fs_idx>).
      <fs_idx> = mod_idx = mod_idx + 1.
    ENDIF.
    INSERT <fs_inline> INTO TABLE <fs_modtab> .

    otab = VALUE #( BASE otab  FOR wa IN gt_keys
                    WHERE ( key IS NOT INITIAL )
                    descending = abap_true
                    ( name = wa-field ) ).

    SORT <fs_modtab> BY (otab).

    DATA(lt_del) = VALUE tt_fields( FOR wa IN gt_keys WHERE ( key = abap_true AND idx IS INITIAL )
                        ( wa ) ).
    DATA(del1) = VALUE #( lt_del[ 1 ]-field OPTIONAL ).
    DATA(del2) = VALUE #( lt_del[ 2 ]-field OPTIONAL ).
    DATA(del3) = VALUE #( lt_del[ 3 ]-field OPTIONAL ).
    DATA(del4) = VALUE #( lt_del[ 4 ]-field OPTIONAL ).
    DATA(del5) = VALUE #( lt_del[ 5 ]-field OPTIONAL ).
    DELETE ADJACENT DUPLICATES FROM <fs_modtab> COMPARING (del1) (del2) (del3) (del4) (del5).

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->ATTA_BORRAR
* +-------------------------------------------------------------------------------------------------+
* | [<-()] R_OK                           TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD atta_borrar.
    DATA: go_myobject TYPE REF TO cl_gos_manager,
          w_logsys    TYPE tbdls-logsys,
          w_container TYPE REF TO cl_gui_custom_container.

    DATA(objkey) = me->get_tabkey_from_sel( ).
    CHECK objkey IS NOT INITIAL.

    DATA(objtype) = VALUE saeobjid( gt_cnst[ fname = c_bo_bau ]-low OPTIONAL ).
    DATA(ip_service) = VALUE sgs_srvnam( gt_cnst[ fname = c_ip_serv_out ]-low OPTIONAL ).
    DATA(obj) = VALUE borident( objtype = objtype
                                objkey = objkey
                                logsys = w_logsys   ). "Info Object // objtype = nombre del Bisness Object
    DATA obj_id TYPE c LENGTH 50.
    obj_id = obj-objkey.

    cl_alink_connection=>find(
      EXPORTING
        sap_object         = obj-objtype
        object_id          = obj_id
        until_ar_date      = sy-datum
      IMPORTING
        connections        = DATA(lt_conn)
      EXCEPTIONS
        not_found          = 1
        error_authorithy   = 2
        error_parameter    = 3
        OTHERS             = 4
    ).
    IF lines( lt_conn ) IS NOT INITIAL.
      DATA(reg) = VALUE #( lt_conn[ 1 ] OPTIONAL ).
      cl_alink_connection=>delete_by_key(
        EXPORTING
          sap_object = reg-sap_object
          object_id  = reg-object_id
          archiv_id  = reg-archiv_id
          arc_doc_id = reg-arc_doc_id
        EXCEPTIONS
          not_found  = 1
          OTHERS     = 2
      ).
      r_ok = COND #( WHEN sy-subrc EQ 0 THEN abap_true ).
    ENDIF.
*BORRARTEST
    r_ok = abap_true.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->ATTA_CARGA
* +-------------------------------------------------------------------------------------------------+
* | [<-()] R_OK                           TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD atta_carga.

    DATA: go_myobject TYPE REF TO cl_gos_manager,
          w_logsys    TYPE tbdls-logsys,
          w_container TYPE REF TO cl_gui_custom_container.

    DATA(objtype) = VALUE saeobjid( gt_cnst[ fname = c_bo_bau ]-low OPTIONAL ).
    DATA(ip_service) = VALUE sgs_srvnam( gt_cnst[ fname = c_ip_serv_in ]-low OPTIONAL ).

    CHECK objtype IS NOT INITIAL AND ip_service IS NOT INITIAL.

    CREATE OBJECT go_myobject.

    CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
      IMPORTING
        own_logical_system             = w_logsys
      EXCEPTIONS
        own_logical_system_not_defined = 1
        OTHERS                         = 2.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

    DATA(obj) = VALUE borident( objtype = objtype
                                objkey = me->get_tabkey_from_sel( )
                                logsys = w_logsys   ). "Info Object // objtype = nombre del Bisness Object

    CALL METHOD go_myobject->start_service_direct
      EXPORTING
        ip_service       = ip_service
        is_object        = obj
        io_container     = w_container
      EXCEPTIONS
        no_object        = 1
        object_invalid   = 2
        execution_failed = 3
        OTHERS           = 4.
    CASE sy-subrc.
      WHEN 0.
        COMMIT WORK.
    ENDCASE.
**********************************************************************
    DATA obj_id TYPE c LENGTH 50.
    obj_id = obj-objkey.

    cl_alink_connection=>find(
      EXPORTING
        sap_object         = obj-objtype
        object_id          = obj_id
        until_ar_date      = sy-datum
      IMPORTING
        connections        = DATA(lt_conn)
      EXCEPTIONS
        not_found          = 1
        error_authorithy   = 2
        error_parameter    = 3
        OTHERS             = 4
    ).
    IF sy-subrc <> 0.
* MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

    r_ok = COND #( WHEN lines( lt_conn ) IS NOT INITIAL THEN abap_true ).
*BORRARTEST
    r_ok = abap_true.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->ATTA_MOSTRAR
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD atta_mostrar.
    DATA: go_myobject TYPE REF TO cl_gos_manager,
          w_logsys    TYPE tbdls-logsys,
          w_container TYPE REF TO cl_gui_custom_container.

    DATA(objtype) = VALUE saeobjid( gt_cnst[ fname = c_bo_bau ]-low OPTIONAL ).
    DATA(ip_service) = VALUE sgs_srvnam( gt_cnst[ fname = c_ip_serv_out ]-low OPTIONAL ).

    CHECK objtype IS NOT INITIAL AND ip_service IS NOT INITIAL.

    CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
      IMPORTING
        own_logical_system             = w_logsys
      EXCEPTIONS
        own_logical_system_not_defined = 1
        OTHERS                         = 2.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

    DATA(obj) = VALUE borident( objtype = objtype
                                objkey = me->get_tabkey_from_sel( )
                                logsys = w_logsys   ). "Info Object // objtype = nombre del Bisness Object

    CREATE OBJECT go_myobject
      EXPORTING
        is_object = obj
        ip_mode   = 'E' "display
*       ip_no_commit = 'X' ""attachments should only be saved by own commits
      EXCEPTIONS
        OTHERS    = 1.
* Llama servicio
    CALL METHOD go_myobject->start_service_direct
      EXPORTING
        ip_service       = ip_service
        is_object        = obj
        io_container     = w_container
      EXCEPTIONS
        no_object        = 1
        object_invalid   = 2
        execution_failed = 3
        OTHERS           = 4.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                 WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->CHECK_CHANGES
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD check_changes.
**********************************************************************
*------------- PARA ALV EDITABLE UNICAMENTE
**********************************************************************
*type required for correct casting
    DATA: lo_model     TYPE REF TO cl_salv_model,
          o_adapter    TYPE REF TO cl_salv_adapter,
          lo_grid      TYPE REF TO cl_gui_alv_grid,
          lo_full_adap TYPE REF TO cl_salv_fullscreen_adapter.

    CHECK gr_table IS BOUND.

    TRY.
*   Narrow casting
        lo_model ?= me->gr_table.
*   Object for the local inherited class from the CL_SALV_MODEL_LIST
        o_adapter ?= lo_model->r_controller->r_adapter.
*   Adapter
        lo_full_adap ?= o_adapter.
*   Get the Grid
        lo_grid = lo_full_adap->get_grid( ).
    ENDTRY.
    lo_grid->check_changed_data( ).
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Public Method ZCL_RT_BAU_REVINV_ALV->CONSTRUCTOR
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_TAB_TO_ALV                   TYPE REF TO DATA
* | [--->] I_KEY_FIELDS                   TYPE        TT_FIELDS
* | [--->] I_STATUS                       TYPE        STRING
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD constructor.
    FIELD-SYMBOLS: <out_tab> TYPE ANY TABLE,
                   <in_tab>  TYPE ANY TABLE.
    DATA out_tab TYPE REF TO data.

**********************************************************************
*    Super class needed for editable ALV
    super->constructor( ).
**********************************************************************

    IF i_tab_to_alv IS BOUND.
      status = i_status.
      gt_keys = i_key_fields.

      ASSIGN i_tab_to_alv->* TO <in_tab>.
      CREATE DATA out_tab LIKE <in_tab>.
      ASSIGN out_tab->* TO <out_tab>.
      <out_tab> = <in_tab>.
      GET REFERENCE OF <out_tab> INTO gt_outab.

      me->create_alv( CHANGING i_tab = <out_tab> ).
    ENDIF.

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->CREATE_ALV
* +-------------------------------------------------------------------------------------------------+
* | [<-->] I_TAB                          TYPE        ANY TABLE
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD create_alv.
    CHECK me->load_cnst( ) EQ abap_true.
*... §2 create an ALV table
    TRY.
        cl_salv_table=>factory(
        IMPORTING
          r_salv_table   = gr_table
        CHANGING
          t_table        = i_tab ).
      CATCH cx_salv_msg.                                "#EC NO_HANDLER
    ENDTRY.

*... §3.1 activate ALV generic Functions

    me->set_functions( CHANGING io_table = gr_table ).

*... set the columns technical

    me->set_columns( CHANGING io_table = gr_table ).

*... §6 register to the events of cl_salv_table

    me->set_events( CHANGING io_table = gr_table ).

*... §7.1 set selection mode
    DATA(lr_selections) = gr_table->get_selections( ).
    lr_selections->set_selection_mode( if_salv_c_selection_mode=>single ).

*... set list title

    DATA: lr_display_settings TYPE REF TO cl_salv_display_settings,
          l_title             TYPE lvc_title.

*    l_title = 'text-t01'.
    lr_display_settings = gr_table->get_display_settings( ).
    lr_display_settings->set_list_header( |Revaloración de Inventario| ).

*... §7 display the table
    gr_table->set_screen_popup(
      start_column = 1
      end_column   = 100
      start_line   = 1
      end_line     = 20 ).

    me->set_sort( i_no_refresh = abap_true  ).

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Public Method ZCL_RT_BAU_REVINV_ALV->DISPLAY_ALV
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_NO_REFRESH                   TYPE        BOOLEAN(optional)
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD display_alv.
    IF gr_table IS BOUND AND i_no_refresh IS INITIAL.
      gr_table->refresh( ).
    ELSE.
      gr_table->display( ).
    ENDIF.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->END_PROCESS
* +-------------------------------------------------------------------------------------------------+
* | [<-()] R_OK                           TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD end_process.
    RAISE EVENT to_end EXPORTING e_to_end = gt_outab.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->GET_REGS_FROM_DIST
* +-------------------------------------------------------------------------------------------------+
* | [<-()] R_TAB                          TYPE REF TO DATA
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD get_regs_from_dist.
    FIELD-SYMBOLS: <fs_intab> TYPE ANY TABLE,
                   <fs_outab> TYPE STANDARD TABLE.
    DATA lr TYPE REF TO data.
*debería estar en ZCL...DATA
    CREATE DATA r_tab TYPE TABLE OF REF TO data.
    ASSIGN r_tab->* TO <fs_outab>.

    ASSIGN gt_outab->* TO <fs_intab>.

    DATA(rem_data) = get_tabkey_from_sel( abap_true ).
    DATA(cond) = ||.
    LOOP AT gt_keys REFERENCE INTO DATA(key) WHERE sort IS NOT INITIAL.
      SPLIT rem_data AT parser INTO: DATA(key_data) rem_data.
      cond = COND #( WHEN key_data IS INITIAL THEN cond ELSE
                     |{ cond }{ key->*-field } = { key_data } {
                                     COND #( WHEN rem_data IS NOT INITIAL THEN |AND | ELSE || ) }| ) .
    ENDLOOP.

    LOOP AT <fs_intab> ASSIGNING FIELD-SYMBOL(<fs_line>) WHERE (cond).
      GET REFERENCE OF <fs_line> INTO lr.
      APPEND lr TO <fs_outab>.
    ENDLOOP.

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->GET_TABKEY_FROM_SEL
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_TO_PARSE                     TYPE        BOOLEAN(optional)
* | [<-()] R_TABKEY                       TYPE        STRING
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD get_tabkey_from_sel.
    IF i_to_parse EQ abap_true AND selection_key-sel_key_p IS NOT INITIAL.
      r_tabkey = selection_key-sel_key_p.
    ELSEIF i_to_parse EQ abap_false AND selection_key-sel_key IS NOT INITIAL.
      r_tabkey = selection_key-sel_key.
    ELSE.
      DATA(lt_rows) = gr_table->get_selections( )->get_selected_rows( ).
      CHECK lines( lt_rows ) IS NOT INITIAL.

*recives only one line
      FIELD-SYMBOLS: <fst> TYPE STANDARD TABLE.

      ASSIGN gt_outab->* TO <fst>.

      READ TABLE <fst> ASSIGNING FIELD-SYMBOL(<fsl>) INDEX lt_rows[ 1 ].

      LOOP AT gt_keys REFERENCE INTO DATA(key) WHERE sort IS NOT INITIAL .
        ASSIGN COMPONENT key->*-field OF STRUCTURE <fsl> TO FIELD-SYMBOL(<key>).
        IF i_to_parse IS INITIAL.
          r_tabkey = selection_key-sel_key = |{ r_tabkey }{ <key> }|.
        ELSE.
          r_tabkey = selection_key-sel_key_p = |{ r_tabkey }{ <key> }{ parser }|.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->HANDLE_DATA_CHANGED
* +-------------------------------------------------------------------------------------------------+
* | [--->] ER_DATA_CHANGED                LIKE
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD handle_data_changed.
    DATA line_to_mod TYPE REF TO data.
    FIELD-SYMBOLS <mp_mod_rows> TYPE ANY TABLE.

    ASSIGN er_data_changed->mp_mod_rows->* TO <mp_mod_rows>.
    LOOP AT <mp_mod_rows> ASSIGNING FIELD-SYMBOL(<fs_line>).
      GET REFERENCE OF <fs_line> INTO line_to_mod.
      me->add_to_mod_db( i_line = line_to_mod ).
    ENDLOOP.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->LOAD_CNST
* +-------------------------------------------------------------------------------------------------+
* | [<-()] I_OK                           TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD load_cnst.
*    LOAD ZIM_CNST
*ZZMOD  ZZMOD
*    rt
*ZZPROYT  ZZPROYT
*bau
*REPID  PROGRAMM
*zcl_rt_bau_revinv
*FNAME  FNAME_021

*NUMB	TVARV_NUMB
*SIGN	TVARV_SIGN
*OPTI	TVARV_OPTI
*LOW  TVARV_VAL
*HIGH	TVARV_VAL
    SELECT * FROM zim_cnst
      INTO CORRESPONDING FIELDS OF TABLE gt_cnst
      WHERE zzmod = 'RT'
      AND zzproyt = 'BAU'
      AND repid = sy-repid.

    gt_cnst = VALUE #( ( fname = c_bo_bau numb = 1 low = 'ZBUS_BONIF' )
                       ( fname = c_ip_serv_in numb = 1 low = 'ARL_LINK' )
                       ( fname = c_ip_serv_out numb = 1 low = 'ARL_LINK' ) ).

    IF lines( gt_cnst ) IS NOT INITIAL.
      i_ok = abap_true.
    ENDIF.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->SAVE_DATA
* +-------------------------------------------------------------------------------------------------+
* | [<-->] O_TAB                          TYPE REF TO DATA(optional)
* | [<-()] I_OK                           TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD save_data.
    CHECK gt_to_db IS BOUND.
    RAISE EVENT to_save EXPORTING mod_tab = gt_to_db.

*   Changed by event handler.
    i_ok = save_ok.
    CLEAR: gt_to_db, mod_idx.
    save_ok = abap_false.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->SAVE_SEQUENCE
* +-------------------------------------------------------------------------------------------------+
* | [<-()] R_OK                           TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD save_sequence.
    r_ok = abap_false.
    IF gt_to_db IS BOUND.
      RAISE EVENT to_val EXPORTING e_to_val = gt_to_db.
      IF val_ok NE abap_true.
        send_message( i_type_message = 'E'    " p = popup
                      i_message      = |{ text-m04 }| ).
      ELSE.
        val_ok = abap_false.
        CASE send_message( i_type_message = 'P'
                     i_conf    = abap_true
                     i_message = |{ text-m01 }| ).
          WHEN '1'. "respuesta popup
            IF me->save_data( ) EQ abap_true.
              send_message( i_type_message = 'S'
                            i_message = |{ text-m02 }| ).
              r_ok = abap_true.
            ELSE.
              send_message( i_type_message = 'E'
                            i_message = |{ text-m03 }| ).
            ENDIF.

          WHEN OTHERS.
            r_ok = abap_true.
        ENDCASE.
      ENDIF.
    ELSE.
      r_ok = abap_true.
    ENDIF.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Static Public Method ZCL_RT_BAU_REVINV_ALV=>SEND_MESSAGE
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_TYPE_MESSAGE                 TYPE        CHAR1
* | [--->] I_CONF                         TYPE        BOOLEAN(optional)
* | [--->] I_MESSAGE                      TYPE        STRING
* | [<-()] R_OK                           TYPE        CHAR1
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD send_message.
    CASE i_type_message.
      WHEN 'P'.
        DATA(ans) = ''.
        CALL FUNCTION 'POPUP_TO_CONFIRM'
          EXPORTING
*           titlebar      = SPACE
*           diagnose_object       = SPACE
            text_question = i_message
          IMPORTING
            answer        = ans.
        IF sy-subrc <> 0.
*     MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
        ENDIF.
        r_ok = ans.
      WHEN OTHERS.
        MESSAGE i_message TYPE i_type_message DISPLAY LIKE 'W'.
    ENDCASE.

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->SET_COLUMNS
* +-------------------------------------------------------------------------------------------------+
* | [<-->] IO_TABLE                       TYPE REF TO CL_SALV_TABLE
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD set_columns.
    DATA: lr_columns TYPE REF TO cl_salv_columns_table,
          lr_column  TYPE REF TO cl_salv_column_table.

    lr_columns = io_table->get_columns( ).
    lr_columns->set_optimize( abap_true ).

* Set text for column
    LOOP AT gt_keys REFERENCE INTO DATA(key) WHERE text IS NOT INITIAL.
      TRY.
          lr_column ?= lr_columns->get_column( |{ key->*-field }| ).
          lr_column->set_short_text( value = |{ key->*-text }| ).
          lr_column->set_medium_text( value = |{ key->*-text }| ).
          lr_column->set_long_text( value = |{ key->*-text }| ).
        CATCH cx_salv_not_found.                        "#EC NO_HANDLER
      ENDTRY.
    ENDLOOP.

* Set ICON column
    LOOP AT gt_keys REFERENCE INTO key WHERE icon IS NOT INITIAL.
      TRY.
          lr_column ?= lr_columns->get_column( |{ key->*-field }| ).
          lr_column->set_icon( if_salv_c_bool_sap=>true ).
          lr_column->set_long_text( |{ key->*-text }| ).
        CATCH cx_salv_not_found.                        "#EC NO_HANDLER
      ENDTRY.
    ENDLOOP.

* Set tech column
    LOOP AT gt_keys REFERENCE INTO key WHERE tech IS NOT INITIAL.
      TRY .
          lr_column ?= lr_columns->get_column( |{ key->*-field }| ).
          lr_column->set_technical(
              value = if_salv_c_bool_sap=>true
          ).
      ENDTRY.
    ENDLOOP.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Public Method ZCL_RT_BAU_REVINV_ALV->SET_DATA_SAVED
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_SAVE_OK                      TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD set_data_saved.
    save_ok = i_save_ok.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->SET_EDITABLE
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_FIELDS                       TYPE        TT_FIELDS
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD set_editable.
**********************************************************************
*------------- PARA ALV EDITABLE UNICAMENTE
**********************************************************************
*type required for correct casting
    DATA: lo_model     TYPE REF TO cl_salv_model,
          o_adapter    TYPE REF TO cl_salv_adapter,
          lo_grid      TYPE REF TO cl_gui_alv_grid,
          lo_full_adap TYPE REF TO cl_salv_fullscreen_adapter.

    CHECK gr_table IS BOUND.

    TRY.
*   Narrow casting
        lo_model ?= me->gr_table.
*   Object for the local inherited class from the CL_SALV_MODEL_LIST
        o_adapter ?= lo_model->r_controller->r_adapter.
*   Adapter
        lo_full_adap ?= o_adapter.
*   Get the Grid
        lo_grid = lo_full_adap->get_grid( ).
    ENDTRY.

*   Get catalog via grid
    DATA lt_fcat TYPE lvc_t_fcat.

    IF lo_grid IS BOUND.
      lo_grid->get_frontend_fieldcatalog( IMPORTING et_fieldcatalog = lt_fcat ).
    ENDIF.
*    Get catalog via controller
*    DATA(rt_fcat) = cl_salv_controller_metadata=>get_lvc_fieldcatalog(
*          r_columns = gr_table->get_columns( ) " ALV Filter
*          r_aggregations = gr_table->get_aggregations( ) " ALV Aggregations
*          ).

*    Editable ALV - all
*    DATA: ls_layout TYPE lvc_s_layo.
*    ls_layout-edit = 'X'.
*    CALL METHOD lo_grid->set_frontend_layout EXPORTING is_layout = ls_layout.

    LOOP AT i_fields REFERENCE INTO DATA(field) WHERE edit = abap_true.
      TRY .
          lt_fcat[ fieldname = field->*-field ]-edit = abap_true.
      ENDTRY.
    ENDLOOP.

    lo_grid->set_frontend_fieldcatalog( it_fieldcatalog = lt_fcat ).

    SET HANDLER me->handle_data_changed FOR lo_grid.
*   refresh the table
    CALL METHOD lo_grid->refresh_table_display.
**********************************************************************

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->SET_EVENTS
* +-------------------------------------------------------------------------------------------------+
* | [<-->] IO_TABLE                       TYPE REF TO CL_SALV_TABLE
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD set_events.
    DATA: lr_events TYPE REF TO cl_salv_events_table.
    lr_events = gr_table->get_event( ).

*    CREATE OBJECT gr_events.

**********************************************************************
* ONLY SALV EVENT
**********************************************************************

**... §6.1 register to the event USER_COMMAND
    SET HANDLER me->user_commando FOR lr_events.
**... §6.2 register to the event BEFORE_SALV_FUNCTION
*    SET HANDLER gr_events->on_before_salv_function FOR lr_events.
**... §6.3 register to the event AFTER_SALV_FUNCTION
*    SET HANDLER gr_events->on_after_salv_function FOR lr_events.
**... §6.4 register to the event DOUBLE_CLICK
*    SET HANDLER gr_events->on_double_click FOR lr_events.
**... §6.5 register to the event LINK_CLICK
*    SET HANDLER gr_events->on_link_click FOR lr_events.


  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->SET_FUNCTIONS
* +-------------------------------------------------------------------------------------------------+
* | [<-->] IO_TABLE                       TYPE REF TO CL_SALV_TABLE
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD set_functions.
    DATA: lr_functions TYPE REF TO cl_salv_functions_list,
          l_text       TYPE string,
          l_icon       TYPE string.
*functions via status because no grid declared
    TRY .
        CALL METHOD io_table->set_screen_status
          EXPORTING
            report   = 'SAPLZFG_RT_BAU_UTIL'
            pfstatus = |{ status }|.
      CATCH cx_root.
    ENDTRY.

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->SET_SORT
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_NO_REFRESH                   TYPE        BOOLEAN(optional)
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD set_sort.
**********************************************************************
*------------- PARA SORT
**********************************************************************
    CHECK gr_table IS BOUND.

    DATA(sort) = me->gr_table->get_sorts( ).
    sort->clear( ).

    LOOP AT gt_keys REFERENCE INTO DATA(keys) WHERE sort IS NOT INITIAL.
      TRY.
          sort->add_sort( columnname = |{ keys->*-field }|
                          position = keys->*-sort ).
        CATCH cx_salv_not_found.    "
        CATCH cx_salv_existing.    "
        CATCH cx_salv_data_error.    "
      ENDTRY.
    ENDLOOP.

    IF i_no_refresh EQ abap_false.
      me->display_alv( ).
    ENDIF.
**********************************************************************
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Public Method ZCL_RT_BAU_REVINV_ALV->SET_VAL_OK
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_VAL_OK                       TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD set_val_ok.
    val_ok = abap_true.
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->UPDATE_LINE
* +-------------------------------------------------------------------------------------------------+
* | [--->] I_TAB                          TYPE REF TO DATA
* | [--->] I_FILED                        TYPE        BOOLEAN
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD update_line.
    FIELD-SYMBOLS: <fs_intab>  TYPE ANY TABLE. "incoming tab
    DATA: out_line TYPE REF TO data,
          eve_line TYPE REF TO data.

    CHECK i_tab IS BOUND.

    ASSIGN i_tab->* TO <fs_intab>.

    "deberia estar en ZCL...DATA.
    LOOP AT <fs_intab> ASSIGNING FIELD-SYMBOL(<fs_line>).
      ASSIGN <fs_line>->* TO FIELD-SYMBOL(<fs_st>).
*      LOOP AT gt_keys REFERENCE INTO DATA(key) WHERE icon = abap_true.
*        ASSIGN COMPONENT key->*-field OF STRUCTURE <fs_st> TO FIELD-SYMBOL(<fs_field>).
      " modify global master data
      GET REFERENCE OF <fs_st> INTO eve_line.
      RAISE EVENT to_update EXPORTING e_to_update = eve_line e_info = get_tabkey_from_sel( ).
*        <fs_field> = COND #( WHEN <fs_field> IS ASSIGNED
*                        THEN COND icon_d( WHEN i_filed EQ abap_true THEN icon_okay ELSE icon_cancel ) ).
*      ENDLOOP.
      " append modified reg to update db
      GET REFERENCE OF <fs_st> INTO out_line.
      me->add_to_mod_db( i_line = out_line ).
    ENDLOOP.

    me->display_alv( ).
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Instance Private Method ZCL_RT_BAU_REVINV_ALV->USER_COMMANDO
* +-------------------------------------------------------------------------------------------------+
* | [--->] E_SALV_FUNCTION                LIKE
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD user_commando.
    CLEAR: selection_key.
*    IF editable EQ abap_true.
    me->check_changes( ).
*    ENDIF.

    CASE  e_salv_function.
      WHEN 'LOAD'.
        IF me->atta_borrar( ) EQ abap_true AND
           me->atta_carga( ) EQ abap_true.
          update_line(
            EXPORTING
              i_filed = abap_true
              i_tab   = me->get_regs_from_dist( )
          ).
        ENDIF.
      WHEN 'SHOW'.
        me->atta_mostrar( ).
      WHEN 'EDIT'.
        me->set_editable(
        i_fields = VALUE tt_fields( FOR wa IN gt_keys WHERE ( edit = abap_true ) ( wa ) )
        ).
      WHEN 'SAVE'.
        me->save_sequence( ).
      WHEN 'CANCEL' OR 'EXIT'.
        IF me->save_sequence( ) EQ abap_true.
*       leave popup
*       - (currently) not supported via code &AC1
          me->end_process( ).
          me->gr_table->close_screen( ).
        ENDIF.
    ENDCASE.

  ENDMETHOD.
ENDCLASS.